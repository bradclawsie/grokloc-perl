image: archlinux
packages:
  - cpanminus
  - just
  - perl-dbd-pg
  - postgresql
  - postgresql-libs
  - valkey
environment:
  PERL5LIB: "$HOME/grokloc-perl/lib:$HOME/grokloc-perl/local/lib/perl5"
tasks:
  - grokloc-db: |
      git clone https://git.sr.ht/~bradclawsie/grokloc-db
      pushd grokloc-db
      sudo just initdb
      sudo systemctl start postgresql.service && sleep 3
      just create-users create-databases alter-grants apply-schema
      popd
  - valkey: |
      sudo systemctl start valkey.service && sleep 1
  - deps: |
      pushd grokloc-perl
      mkdir -p local
      /usr/bin/vendor_perl/cpanm -l local -n Carton
      PERL5LIB="$HOME/grokloc-perl/local/lib/perl5"; local/bin/carton install
  - tests: |
      pushd grokloc-perl
      just check critic test

